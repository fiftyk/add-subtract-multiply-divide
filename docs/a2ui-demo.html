<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A2UI Protocol Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    header p {
      opacity: 0.9;
    }

    .status-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .status-item {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
    }

    .status-dot.connected {
      background: #4caf50;
      animation: pulse 2s infinite;
    }

    .status-dot.disconnected {
      background: #f44336;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .panel-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-body {
      padding: 20px;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
    }

    .ui-preview {
      background: #fafafa;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      min-height: 200px;
    }

    /* A2UI Components */
    .a2ui-text {
      padding: 10px 0;
      color: #333;
    }

    .a2ui-button {
      display: inline-block;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      margin: 5px;
    }

    .a2ui-button:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .a2ui-button:active {
      transform: translateY(0);
    }

    .a2ui-input {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
      max-width: 300px;
      margin: 5px;
    }

    .a2ui-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .a2ui-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 10px 0;
    }

    .a2ui-select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      margin: 5px;
    }

    .a2ui-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .a2ui-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    /* Message log */
    .message-item {
      padding: 10px 15px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      background: #f8f9fa;
      border-left: 3px solid #667eea;
    }

    .message-item.surface-update {
      border-left-color: #4caf50;
    }

    .message-item.data-model {
      border-left-color: #ff9800;
    }

    .message-item.begin-rendering {
      border-left-color: #2196f3;
    }

    .message-item.user-action {
      border-left-color: #e91e63;
    }

    .message-type {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
    }

    .message-content {
      color: #666;
      word-break: break-all;
    }

    /* Actions panel */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .action-btn.primary {
      background: #667eea;
      color: white;
    }

    .action-btn.secondary {
      background: #e9ecef;
      color: #333;
    }

    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>A2UI Protocol Demo</h1>
      <p>Google A2UI 协议演示 - Server-Sent Events 实时消息流</p>
    </header>

    <div class="status-bar">
      <div class="status-item">
        <div class="status-dot disconnected" id="connectionStatus"></div>
        <span id="connectionText">未连接</span>
      </div>
      <div class="status-item">
        <span>会话 ID:</span>
        <span id="sessionId">-</span>
      </div>
      <div class="status-item">
        <span>消息数:</span>
        <span id="messageCount">0</span>
      </div>
    </div>

    <div class="main-content">
      <div class="panel">
        <div class="panel-header">
          <span>UI 预览</span>
          <button class="action-btn secondary" onclick="clearUI()">清空</button>
        </div>
        <div class="panel-body">
          <div id="uiContainer" class="ui-preview">
            <div class="empty-state">创建会话后，UI 组件将显示在这里</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>消息日志</span>
          <button class="action-btn secondary" onclick="clearMessages()">清空</button>
        </div>
        <div class="panel-body" id="messageLog">
          <div class="empty-state">等待消息...</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
      <div class="panel-header">
        <span>操作面板</span>
      </div>
      <div class="panel-body">
        <div class="action-buttons">
          <button class="action-btn primary" onclick="createSession()">创建会话</button>
          <button class="action-btn secondary" onclick="connectStream()">连接 SSE</button>
          <button class="action-btn secondary" onclick="sendSurfaceUpdate()">发送 Surface 更新</button>
          <button class="action-btn secondary" onclick="sendDataModel()">发送数据模型</button>
          <button class="action-btn secondary" onclick="startRendering()">开始渲染</button>
          <button class="action-btn secondary" onclick="deleteSession()">删除会话</button>
        </div>

        <div class="form-group">
          <label>自定义 Surface 更新 (JSON):</label>
          <textarea id="customSurface" style="width:100%;height:100px;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;">
{
  "components": [
    {"id":"text1","component":{"Text":{"text":{"literalString":"Hello A2UI!"}}}},
    {"id":"input1","component":{"TextInput":{"placeholder":{"literalString":"输入内容..."}}}},
    {"id":"btn1","component":{"Button":{"label":{"literalString":"点击我"},"onClick":{"literalString":"submit"}}}}
  ]
}</textarea>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
      <div class="panel-header">
        <span>交互式会话</span>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label>用户请求:</label>
          <input type="text" id="userRequest" placeholder="例如: 请提供您的姓名和年龄，我将帮您创建待办事项" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" value="请提供您的姓名和年龄">
        </div>

        <div class="form-group">
          <label>或输入已创建的计划 ID:</label>
          <input type="text" id="planId" placeholder="例如: plan-abc123" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
        </div>

        <div class="action-buttons">
          <button class="action-btn primary" onclick="startInteractiveSession()">启动交互式会话</button>
          <button class="action-btn secondary" onclick="confirmExecution()">确认执行</button>
          <button class="action-btn secondary" onclick="cancelSession()">取消会话</button>
        </div>

        <div id="interactiveSessionInfo" style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:6px;display:none;">
          <strong>会话状态:</strong> <span id="sessionStatus">-</span><br>
          <strong>步骤数:</strong> <span id="stepCount">0</span><br>
          <strong>当前步骤:</strong> <span id="currentStep">-</span>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
      <div class="panel-header">
        <span>交互式表单</span>
        <button class="action-btn secondary" onclick="refreshPendingInputs()">刷新待输入</button>
      </div>
      <div class="panel-body">
        <div id="interactiveFormContainer" class="ui-preview">
          <div class="empty-state">启动交互式会话后，当需要用户输入时会显示表单</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
      <div class="panel-header">
        <span>函数执行</span>
        <button class="action-btn secondary" onclick="loadFunctions()">刷新函数列表</button>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label>选择函数:</label>
          <select id="functionSelect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
            <option value="">-- 请选择函数 --</option>
          </select>
        </div>

        <div class="form-group">
          <label>参数 (JSON格式):</label>
          <textarea id="functionParams" style="width:100%;height:80px;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;">{}</textarea>
        </div>

        <button class="action-btn primary" onclick="executeFunction()">执行函数</button>

        <div id="functionResult" style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:6px;display:none;">
          <strong>执行结果:</strong>
          <pre id="functionResultContent" style="margin-top:10px;white-space:pre-wrap;word-break:break-all;"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let sessionId = null;
    let eventSource = null;
    let messageCount = 0;
    let interactiveSessionId = null;

    // API Configuration
    // Port 3000: REST API server
    // Port 3001: SSE/WebSocket server
    const REST_API_PORT = '3000';
    const SSE_PORT = '3001';

    // API Base URLs - REST API is on port 3000, SSE is on port 3001
    const API_BASE = `http://localhost:${REST_API_PORT}/api/a2ui`;
    const INTERACTIVE_API_BASE = `http://localhost:${REST_API_PORT}/api/interactive-a2ui`;
    const SSE_URL = `http://localhost:${SSE_PORT}`;

    console.log('API Configuration:', { REST_API_PORT, SSE_PORT, API_BASE, INTERACTIVE_API_BASE, SSE_URL });

    // Interactive form state
    let pendingInputs = [];
    let currentStepId = null;

    // Update connection status
    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connectionStatus');
      const text = document.getElementById('connectionText');
      dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
      text.textContent = connected ? '已连接' : '未连接';
    }

    // Create new A2UI session
    async function createSession() {
      try {
        const response = await fetch(`${API_BASE}/sessions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        if (result.success) {
          sessionId = result.data.sessionId;
          document.getElementById('sessionId').textContent = sessionId;
          logMessage('session_created', result.data);
          showToast('会话创建成功: ' + sessionId);
        } else {
          showToast('创建失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Connect to SSE stream
    function connectStream() {
      if (!sessionId) {
        showToast('请先创建会话', true);
        return;
      }

      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`${API_BASE}/sessions/${sessionId}/stream`);

      eventSource.onopen = () => {
        updateConnectionStatus(true);
        logMessage('connected', { sessionId });
        showToast('SSE 连接已建立');
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          messageCount++;
          document.getElementById('messageCount').textContent = messageCount;
          handleMessage(data);
        } catch (error) {
          console.error('Parse error:', error);
        }
      };

      eventSource.onerror = () => {
        updateConnectionStatus(false);
        showToast('SSE 连接断开', true);
      };
    }

    // Handle incoming A2UI messages
    function handleMessage(data) {
      // Determine message type
      let type = 'unknown';
      let logClass = '';

      if (data.type === 'connected') {
        type = 'connected';
        logClass = 'user-action';
      } else if (data.surfaceUpdate) {
        type = 'surface_update';
        logClass = 'surface-update';
        renderSurface(data.surfaceUpdate);
      } else if (data.dataModelUpdate) {
        type = 'data_model';
        logClass = 'data-model';
      } else if (data.beginRendering) {
        type = 'begin_rendering';
        logClass = 'begin-rendering';
      } else if (data.deleteSurface) {
        type = 'delete_surface';
        logClass = 'user-action';
        clearUI();
      } else if (data.userAction) {
        type = 'user_action';
        logClass = 'user-action';
        logUserAction(data.userAction);
      }

      logMessage(type, data, logClass);
    }

    // Render surface components
    function renderSurface(surfaceUpdate) {
      const container = document.getElementById('uiContainer');
      container.innerHTML = '';

      const components = surfaceUpdate.components || [];
      components.forEach(comp => {
        const element = createComponentElement(comp);
        if (element) {
          container.appendChild(element);
        }
      });

      if (components.length === 0) {
        container.innerHTML = '<div class="empty-state">无组件</div>';
      }
    }

    // Create DOM element from A2UI component
    function createComponentElement(comp) {
      const { id, component } = comp;
      if (!component) return null;

      const container = document.createElement('div');
      container.dataset.id = id;

      // Process each component type
      for (const [type, props] of Object.entries(component)) {
        const element = document.createElement('div');
        element.className = `a2ui-${type.toLowerCase()}`;

        switch (type) {
          case 'Text':
            const text = resolveValue(props.text);
            element.textContent = text || '';
            break;

          case 'Button':
            const label = resolveValue(props.label);
            element.textContent = label || 'Button';
            element.onclick = () => sendUserAction(id, props.onClick);
            break;

          case 'TextInput':
            const placeholder = resolveValue(props.placeholder) || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'a2ui-input';
            input.placeholder = placeholder;
            element.appendChild(input);
            break;

          case 'Card':
            element.className = 'a2ui-card';
            if (props.title) {
              const title = document.createElement('h3');
              title.textContent = resolveValue(props.title) || '';
              element.appendChild(title);
            }
            break;

          case 'Select':
            const select = document.createElement('select');
            select.className = 'a2ui-select';
            const options = props.options || [];
            options.forEach(opt => {
              const option = document.createElement('option');
              option.value = resolveValue(opt.value) || '';
              option.textContent = resolveValue(opt.label) || '';
              select.appendChild(option);
            });
            element.appendChild(select);
            break;

          case 'Column':
            element.className = 'a2ui-column';
            // Render children
            if (props.children && Array.isArray(props.children)) {
              props.children.forEach(child => {
                const childElement = createComponentElement(child);
                if (childElement) {
                  element.appendChild(childElement);
                }
              });
            }
            break;

          case 'Row':
            element.className = 'a2ui-row';
            break;

          case 'Form':
            element.className = 'a2ui-form';
            break;

          default:
            element.textContent = `[${type}]`;
        }

        container.appendChild(element);
      }

      return container;
    }

    // Resolve bound value (literal or path reference)
    function resolveValue(value) {
      if (typeof value === 'string') return value;
      if (value === null || value === undefined) return '';

      if (typeof value === 'object') {
        if ('literalString' in value) return value.literalString;
        if ('literalNumber' in value) return String(value.literalNumber);
        if ('literalBoolean' in value) return String(value.literalBoolean);
        if ('path' in value) return `[path:${value.path}]`;
      }

      return String(value);
    }

    // Send surface update
    async function sendSurfaceUpdate() {
      if (!sessionId) {
        showToast('请先创建会话', true);
        return;
      }

      try {
        const customData = document.getElementById('customSurface').value;
        const data = JSON.parse(customData);

        const response = await fetch(`${API_BASE}/sessions/${sessionId}/surface`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
          showToast('Surface 更新已发送');
        } else {
          showToast('发送失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Send data model update
    async function sendDataModel() {
      if (!sessionId) {
        showToast('请先创建会话', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/datamodel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userName: '张三',
            age: 25,
            city: '北京',
            score: 98.5
          })
        });
        const result = await response.json();
        if (result.success) {
          showToast('数据模型更新已发送');
        } else {
          showToast('发送失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Start rendering
    async function startRendering() {
      if (!sessionId) {
        showToast('请先创建会话', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/render`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            catalogId: 'standard',
            rootComponentId: 'root'
          })
        });
        const result = await response.json();
        if (result.success) {
          showToast('渲染已开始');
        } else {
          showToast('发送失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Send user action
    async function sendUserAction(componentId, actionName) {
      if (!sessionId) {
        showToast('请先创建会话', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/actions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            actionName: resolveValue(actionName),
            surfaceId: 'main',
            sourceComponentId: componentId,
            context: { timestamp: new Date().toISOString() }
          })
        });
        const result = await response.json();
        if (result.success) {
          showToast('动作已发送: ' + resolveValue(actionName));
        } else {
          showToast('发送失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Delete session
    async function deleteSession() {
      if (!sessionId) {
        showToast('请先创建会话', true);
        return;
      }

      try {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          updateConnectionStatus(false);
        }

        const response = await fetch(`${API_BASE}/sessions/${sessionId}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
          showToast('会话已删除');
          logMessage('session_deleted', { sessionId });
          clearUI();
          sessionId = null;
          document.getElementById('sessionId').textContent = '-';
        } else {
          showToast('删除失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Log message to panel
    function logMessage(type, data, className = '') {
      const log = document.getElementById('messageLog');
      if (log.querySelector('.empty-state')) {
        log.innerHTML = '';
      }

      const item = document.createElement('div');
      item.className = `message-item ${className}`;

      const typeLabels = {
        connected: '连接成功',
        session_created: '会话创建',
        surface_update: 'Surface 更新',
        data_model: '数据模型',
        begin_rendering: '开始渲染',
        user_action: '用户动作',
        session_deleted: '会话删除'
      };

      let content = '';
      if (type === 'connected' || type === 'session_created' || type === 'session_deleted') {
        content = JSON.stringify(data, null, 2);
      } else if (type === 'surface_update') {
        content = `Surface: ${data.surfaceUpdate?.surfaceId}\n组件数: ${data.surfaceUpdate?.components?.length || 0}`;
      } else if (type === 'data_model') {
        content = `Path: ${data.dataModelUpdate?.path || '/'}\n数据: ${JSON.stringify(data.dataModelUpdate?.contents)}`;
      } else {
        content = JSON.stringify(data, null, 2);
      }

      item.innerHTML = `
        <div class="message-type">${typeLabels[type] || type}</div>
        <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
      `;

      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
    }

    // Log user action
    function logUserAction(action) {
      logMessage('user_action', {
        name: action.name,
        component: action.sourceComponentId,
        context: action.context
      }, 'user-action');
      showToast(`用户动作: ${action.name} (${action.sourceComponentId})`);
    }

    // Clear UI
    function clearUI() {
      document.getElementById('uiContainer').innerHTML = '<div class="empty-state">UI 已清空</div>';
    }

    // Clear messages
    function clearMessages() {
      document.getElementById('messageLog').innerHTML = '<div class="empty-state">等待消息...</div>';
      messageCount = 0;
      document.getElementById('messageCount').textContent = '0';
    }

    // Toast notification
    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 15px 25px;
        background: ${isError ? '#f44336' : '#4caf50'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // Add animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateY(0); opacity: 1; }
        to { transform: translateY(20px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Initialize
    console.log('A2UI Demo Page Loaded');

    // Load available functions on page load
    loadFunctions();

    // Load available functions
    async function loadFunctions() {
      try {
        const response = await fetch(`${API_BASE}/functions`);
        const result = await response.json();
        if (result.success) {
          const select = document.getElementById('functionSelect');
          // Keep the first option
          select.innerHTML = '<option value="">-- 请选择函数 --</option>';
          result.data.forEach(fn => {
            const option = document.createElement('option');
            option.value = fn.name;
            option.textContent = `${fn.name} - ${fn.description || '无描述'}`;
            option.dataset.parameters = JSON.stringify(fn.parameters || []);
            select.appendChild(option);
          });
          showToast(`已加载 ${result.data.length} 个函数`);
        }
      } catch (error) {
        console.error('Failed to load functions:', error);
        showToast('加载函数列表失败: ' + error.message, true);
      }
    }

    // Execute function
    async function executeFunction() {
      if (!sessionId) {
        showToast('请先创建会话并连接 SSE', true);
        return;
      }

      const functionName = document.getElementById('functionSelect').value;
      if (!functionName) {
        showToast('请选择要执行的函数', true);
        return;
      }

      let parameters;
      try {
        const paramsText = document.getElementById('functionParams').value;
        parameters = JSON.parse(paramsText);
      } catch (error) {
        showToast('参数 JSON 格式错误', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/execute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            functionName,
            parameters,
          })
        });
        const result = await response.json();

        const resultDiv = document.getElementById('functionResult');
        const resultContent = document.getElementById('functionResultContent');
        resultDiv.style.display = 'block';

        if (result.success) {
          resultContent.innerHTML = `<span style="color:#4caf50;">✓ 执行成功</span>
执行时间: ${result.data.executionTime}ms
返回值: ${JSON.stringify(result.data.result, null, 2)}`;
          showToast(`函数执行成功 (${result.data.executionTime}ms)`);
        } else {
          resultContent.innerHTML = `<span style="color:#f44336;">✗ 执行失败</span>
错误: ${result.data.error}`;
          showToast('函数执行失败: ' + result.data.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // ==================== Interactive Session Functions ====================

    // Start interactive session
    async function startInteractiveSession() {
      const request = document.getElementById('userRequest').value.trim();
      const planId = document.getElementById('planId').value.trim();

      if (!request && !planId) {
        showToast('请输入用户请求或计划 ID', true);
        return;
      }

      try {
        const response = await fetch(`${INTERACTIVE_API_BASE}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ request, planId })
        });
        const result = await response.json();

        if (result.success) {
          interactiveSessionId = result.data.sessionId;
          document.getElementById('interactiveSessionInfo').style.display = 'block';
          updateInteractiveSessionInfo(result.data);

          showToast('交互式会话已启动: ' + interactiveSessionId);
          logMessage('interactive_session_started', result.data);

          // Start polling for updates
          startPolling();
        } else {
          showToast('启动失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Polling for interactive session updates (instead of SSE)
    let pollingInterval = null;

    function startPolling() {
      if (pollingInterval) return;
      pollingInterval = setInterval(async () => {
        if (!interactiveSessionId) return;
        await checkPendingInputs();
        await refreshSessionStatus();
      }, 1000); // Poll every second
      showToast('开始轮询更新');
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Check for pending inputs
    async function checkPendingInputs() {
      if (!interactiveSessionId) return;

      try {
        const response = await fetch(`${INTERACTIVE_API_BASE}/${interactiveSessionId}/pending-inputs`);
        if (!response.ok) return;

        const result = await response.json();
        if (result.success && result.data && result.data.forms && result.data.forms.length > 0) {
          // Render the first form
          const form = result.data.forms[0];
          renderInteractiveForm(form.components, form.surfaceId);
          currentStepId = form.stepId;
          showToast('等待用户输入...');
        }
      } catch (error) {
        console.error('Check pending inputs error:', error);
      }
    }

    // Refresh session status
    async function refreshSessionStatus() {
      if (!interactiveSessionId) return;

      try {
        const response = await fetch(`${INTERACTIVE_API_BASE}/${interactiveSessionId}`);
        if (!response.ok) return;

        const result = await response.json();
        if (result.success && result.data) {
          updateInteractiveSessionInfo(result.data);
        }
      } catch (error) {
        console.error('Refresh session status error:', error);
      }
    }

    // Handle interactive session messages (for polling mode)
    function handleInteractiveMessage(data) {
      // Handle different message types
      if (data.surfaceUpdate) {
        renderInteractiveForm(data.surfaceUpdate.components || []);
      }

      if (data.dataModelUpdate) {
        const contents = data.dataModelUpdate.contents || {};
        if (contents.sessionStatus) {
          updateSessionStatus(contents.sessionStatus);
        }
      }

      logMessage('interactive_event', data);
    }

    // Update interactive session info display
    function updateInteractiveSessionInfo(data) {
      document.getElementById('sessionStatus').textContent = data.status || '-';
      document.getElementById('stepCount').textContent = data.steps?.length || 0;

      const currentStep = data.steps?.find((s, i) => i === (data.currentStep || 0));
      if (currentStep) {
        document.getElementById('currentStep').textContent = `${currentStep.description || currentStep.type}`;
      }
    }

    // Update session status
    function updateSessionStatus(status) {
      document.getElementById('sessionStatus').textContent = status;

      const statusLabels = {
        'pending': '待确认',
        'running': '执行中',
        'awaiting_input': '等待输入',
        'completed': '已完成',
        'cancelled': '已取消',
        'error': '错误'
      };

      showToast(`会话状态: ${statusLabels[status] || status}`);
    }

    // Render interactive form from components
    function renderInteractiveForm(components) {
      const container = document.getElementById('interactiveFormContainer');
      container.innerHTML = '';

      if (!components || components.length === 0) {
        container.innerHTML = '<div class="empty-state">无表单组件</div>';
        return;
      }

      components.forEach(comp => {
        const element = createComponentElement(comp);
        if (element) {
          container.appendChild(element);
        }
      });

      // Add submit button if not present
      const hasSubmit = components.some(c => c.id && c.id.includes('submit'));
      if (!hasSubmit) {
        const submitBtn = document.createElement('button');
        submitBtn.className = 'a2ui-button';
        submitBtn.textContent = '提交';
        submitBtn.onclick = () => submitInteractiveForm();
        container.appendChild(submitBtn);
      }
    }

    // Confirm execution
    async function confirmExecution() {
      if (!interactiveSessionId) {
        showToast('请先启动交互式会话', true);
        return;
      }

      try {
        const response = await fetch(`${INTERACTIVE_API_BASE}/${interactiveSessionId}/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confirmed: true })
        });
        const result = await response.json();

        if (result.success) {
          showToast('执行已确认，计划开始运行');
          logMessage('execution_confirmed', result);
        } else {
          showToast('确认失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Cancel session
    async function cancelSession() {
      if (!interactiveSessionId) {
        showToast('请先启动交互式会话', true);
        return;
      }

      try {
        // Stop polling
        stopPolling();

        const response = await fetch(`${INTERACTIVE_API_BASE}/${interactiveSessionId}/cancel`, {
          method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
          showToast('会话已取消');
          logMessage('session_cancelled', { sessionId: interactiveSessionId });
          interactiveSessionId = null;
          document.getElementById('interactiveSessionInfo').style.display = 'none';
        } else {
          showToast('取消失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Refresh pending inputs
    async function refreshPendingInputs() {
      if (!interactiveSessionId) {
        showToast('请先启动交互式会话', true);
        return;
      }

      try {
        const response = await fetch(`${INTERACTIVE_API_BASE}/${interactiveSessionId}/pending-inputs`);
        const result = await response.json();

        if (result.success) {
          pendingInputs = result.data.inputs || [];
          renderPendingForms(result.data.forms || []);
          showToast(`待输入表单: ${pendingInputs.length}`);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // Render pending forms
    function renderPendingForms(forms) {
      const container = document.getElementById('interactiveFormContainer');

      if (!forms || forms.length === 0) {
        container.innerHTML = '<div class="empty-state">无待处理的输入</div>';
        return;
      }

      container.innerHTML = '';
      forms.forEach((form, index) => {
        const formDiv = document.createElement('div');
        formDiv.className = 'a2ui-card';
        formDiv.innerHTML = `<h4>步骤 ${form.stepId}</h4>`;

        const components = form.components || [];
        components.forEach(comp => {
          const element = createComponentElement(comp);
          if (element) {
            formDiv.appendChild(element);
          }
        });

        // Add submit button
        const submitBtn = document.createElement('button');
        submitBtn.className = 'a2ui-button';
        submitBtn.textContent = '提交';
        submitBtn.onclick = () => submitPendingForm(form.stepId, form.surfaceId);
        formDiv.appendChild(submitBtn);

        container.appendChild(formDiv);
      });
    }

    // Submit interactive form (collects values from rendered form)
    async function submitInteractiveForm() {
      if (!interactiveSessionId || currentStepId === null) {
        showToast('无待提交的输入', true);
        return;
      }

      // Collect form values from the UI
      const values = collectFormValues();
      await submitInput(currentStepId, values);
    }

    // Submit pending form
    async function submitPendingForm(stepId, surfaceId) {
      const values = collectFormValues();
      await submitInput(stepId, values);
    }

    // Collect form values from rendered inputs
    function collectFormValues() {
      const values = {};
      const container = document.getElementById('interactiveFormContainer');

      // Find all inputs in the form container
      const inputs = container.querySelectorAll('input, select');
      inputs.forEach(input => {
        const id = input.id || input.name;
        if (id && input.value) {
          // Convert field ID to field name (remove field_ prefix)
          const fieldName = id.replace(/^(form-|input-|field_)/, '');
          values[fieldName] = input.value;
        }
      });

      return values;
    }

    // Submit input to interactive session
    async function submitInput(stepId, values) {
      if (!interactiveSessionId) {
        showToast('会话不存在', true);
        return;
      }

      try {
        const response = await fetch(`${INTERACTIVE_API_BASE}/${interactiveSessionId}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stepId, values })
        });
        const result = await response.json();

        if (result.success) {
          showToast('输入已提交');
          logMessage('input_submitted', { stepId, values });
          // Clear form
          document.getElementById('interactiveFormContainer').innerHTML = '<div class="empty-state">等待下一步...</div>';
        } else {
          showToast('提交失败: ' + result.error, true);
        }
      } catch (error) {
        showToast('请求失败: ' + error.message, true);
      }
    }

    // ==================== End Interactive Session Functions ====================
  </script>
</body>
</html>
