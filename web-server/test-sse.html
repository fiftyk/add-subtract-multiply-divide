<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Server SSE Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #0051D5;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px;
            border-left: 3px solid #007AFF;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #FF3B30;
            background: #fff5f5;
        }
        .log-entry.success {
            border-left-color: #34C759;
            background: #f0fff4;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 14px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.pending { background: #FFD60A; color: #000; }
        .status.executing { background: #007AFF; color: white; }
        .status.waiting { background: #FF9500; color: white; }
        .status.completed { background: #34C759; color: white; }
        .status.error { background: #FF3B30; color: white; }
    </style>
</head>
<body>
    <h1>ðŸš€ Web Server SSE Integration Test</h1>

    <div class="container">
        <h2>1. Select Plan</h2>
        <select id="planSelect">
            <option value="">Loading plans...</option>
        </select>
        <button id="loadPlansBtn">Refresh Plans</button>
        <div id="planInfo" style="margin-top: 10px;"></div>
    </div>

    <div class="container">
        <h2>2. Create & Execute Session</h2>
        <button id="executeBtn" disabled>Execute Plan</button>
        <button id="connectSSEBtn" disabled>Connect SSE</button>
        <div style="margin-top: 10px;">
            Session ID: <span id="sessionId" style="font-family: monospace;">-</span>
            Status: <span id="sessionStatus" class="status">-</span>
        </div>
    </div>

    <div class="container">
        <h2>3. SSE Events</h2>
        <button id="clearLogBtn">Clear Log</button>
        <div id="sseLog" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentPlanId = null;
        let currentSessionId = null;
        let eventSource = null;

        const planSelect = document.getElementById('planSelect');
        const executeBtn = document.getElementById('executeBtn');
        const connectSSEBtn = document.getElementById('connectSSEBtn');
        const loadPlansBtn = document.getElementById('loadPlansBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const planInfo = document.getElementById('planInfo');
        const sessionIdSpan = document.getElementById('sessionId');
        const sessionStatus = document.getElementById('sessionStatus');
        const sseLog = document.getElementById('sseLog');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            sseLog.appendChild(entry);
            sseLog.scrollTop = sseLog.scrollHeight;
        }

        function updateStatus(status) {
            sessionStatus.textContent = status;
            sessionStatus.className = `status ${status}`;
        }

        async function loadPlans() {
            try {
                log('Loading plans...');
                const response = await fetch(`${API_BASE}/plans`);
                const data = await response.json();

                planSelect.innerHTML = '<option value="">Select a plan...</option>';
                data.plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = `${plan.id} - ${plan.userRequest}`;
                    planSelect.appendChild(option);
                });

                log(`Loaded ${data.plans.length} plans`, 'success');
            } catch (error) {
                log(`Error loading plans: ${error.message}`, 'error');
            }
        }

        planSelect.addEventListener('change', async (e) => {
            currentPlanId = e.target.value;
            executeBtn.disabled = !currentPlanId;

            if (currentPlanId) {
                try {
                    const response = await fetch(`${API_BASE}/plans/${currentPlanId}`);
                    const data = await response.json();
                    planInfo.innerHTML = `<strong>Steps:</strong> ${data.plan.steps.length} | <strong>Status:</strong> ${data.plan.status}`;
                    log(`Selected plan: ${currentPlanId}`);
                } catch (error) {
                    log(`Error loading plan details: ${error.message}`, 'error');
                }
            }
        });

        executeBtn.addEventListener('click', async () => {
            try {
                log('Creating session...');
                executeBtn.disabled = true;

                const response = await fetch(`${API_BASE}/sessions/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        planId: currentPlanId,
                        platform: 'web'
                    })
                });

                const data = await response.json();
                currentSessionId = data.sessionId;
                sessionIdSpan.textContent = currentSessionId;
                updateStatus(data.status);

                log(`Session created: ${currentSessionId}`, 'success');
                connectSSEBtn.disabled = false;
            } catch (error) {
                log(`Error creating session: ${error.message}`, 'error');
                executeBtn.disabled = false;
            }
        });

        connectSSEBtn.addEventListener('click', () => {
            if (eventSource) {
                eventSource.close();
            }

            log('Connecting to SSE stream...');
            eventSource = new EventSource(`${API_BASE}/sessions/${currentSessionId}/stream`);

            eventSource.onopen = () => {
                log('SSE connection established', 'success');
                connectSSEBtn.disabled = true;
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`Event: ${data.type}`, 'success');
                    console.log('SSE Event:', data);

                    // Update status based on event type
                    if (data.type === 'executionStart') {
                        updateStatus('executing');
                    } else if (data.type === 'inputRequested') {
                        updateStatus('waiting');
                        log(`Input requested at step ${data.stepId}`, 'success');
                    } else if (data.type === 'executionComplete') {
                        updateStatus('completed');
                        log(`Execution completed: ${data.success ? 'SUCCESS' : 'FAILED'}`, data.success ? 'success' : 'error');
                    } else if (data.type === 'executionError') {
                        updateStatus('error');
                        log(`Error: ${data.error}`, 'error');
                    }
                } catch (error) {
                    log(`Error parsing SSE event: ${error.message}`, 'error');
                }
            };

            eventSource.onerror = (error) => {
                log('SSE connection error', 'error');
                console.error('SSE Error:', error);
                connectSSEBtn.disabled = false;
            };
        });

        clearLogBtn.addEventListener('click', () => {
            sseLog.innerHTML = '';
        });

        loadPlansBtn.addEventListener('click', loadPlans);

        // Load plans on page load
        loadPlans();
    </script>
</body>
</html>
